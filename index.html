<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giphman</title>
   
    <style>
    #search-form {
        width: 500px;
        height: 50px;
    }

    .container{
        display: flex;
        width: 1000px;
        flex-direction: row;
        flex-wrap: wrap;
        align-content: center;
        justify-content: center;
        align-items: center;
        margin:auto;
    }
    
    img{ 
        margin:5px;
        width:200px;
        height:200px;
    }
    </style>
</head>

<body id = "body" style = text-align:center;>
    <div class="container">
        <header>
            <form id="search-form">
                <input id="search-input" type="text" placeholder="search">
                <button type="submit">Search</button>
            </form>
        </header>
        <div id="results" class="results">
        </div>
    </div>
</body>

<script>
const searchForm = document.getElementById("search-form");
const searchInput = document.getElementById("search-input");
const resultsElement = document.getElementById("results");
let apiKey = "5axeqUNKjjSDpnrZGYF4EGNKBKkxh9sY";
let q = "";
let offset = 0;
let resultsHTML = "";
let reloadCount = 0;
resultsElement.innerHTML = "";
let isSafeToLoadMoreGifs = true;
searchForm.addEventListener("submit", function (event) {
  event.preventDefault();
  q = searchInput.value;
  search(q);
  console.log("search1-CALL");
});

function search(q) {
  isSafeToLoadMoreGifs = false;
  console.log({ isSafeToLoadMoreGifs });
  let path = `https://api.giphy.com/v1/gifs/search?api_key=${apiKey}&q=${q}&limit=3&offset=${offset}&rating=g&lang=en`;
  console.log("New Gifs reloaded " + reloadCount + " times");
  let fetchPromise = fetch(path);

  fetchPromise
    .then(function (res) {
      return res.json();
    })
    .then(function (json) {
      json.data.forEach(function (object) {
        console.log(object.images.fixed_width.url);
        const url = object.images.fixed_width.url;
        const width = object.images.fixed_width;
        const height = object.images.fixed_width.height;
        resultsHTML += `
                <img 
                class="gifItem" 
                src="${url}" 
                width="${width}" 
                height="${height}"
                >`;
      });
      isSafeToLoadMoreGifs = true;
      console.log({ isSafeToLoadMoreGifs });
      resultsElement.innerHTML = resultsHTML;
    })
    .catch(function (err) {
      console.log(err.message);
    });
}

window.onscroll = function (ev) {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight) {
    if (isSafeToLoadMoreGifs === true) {
      reloadCount += 1;
      offset += 3;
      console.log("search2-CALL");
      search(q);
    }
  }
};
</script>
</html>